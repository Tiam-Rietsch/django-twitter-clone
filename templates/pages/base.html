{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href=" {% static 'css/Fork-Awesome/css/fork-awesome.min.css' %}?version=1"> -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}?version=1">
    <title>{% block title %}{% endblock title %}Twitter Clone</title>
</head>

<body>
    {% include 'pages/android_navbar.html' %}


    {% block content %}
    {% endblock content %}
    <script>

        LiveUpdates()

        function LiveUpdates() {
            setInterval(() => {
                checkTweetListState()

                function checkTweetListState() {
                    document.querySelectorAll("input[name='tweet-id']").forEach(async item => {
                        let tweetBody = document.querySelector(`.body-${item.value}`)
                        let response = await fetch(`{% url 'check-tweet-existence' %}?pk=${item.value}`, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'checkTweetExistence',
                                'Content-Type': 'application/json'
                            }
                        })

                        let data = await response.json()
                        if (await data['exists'] == false) {
                            tweetCount = document.querySelector('#tweet-count')
                            tweetCount.value = `${parseInt(tweetCount.value) - 1}`;
                            tweetBody.remove()
                        }
                    })
                    refreshLikes()
                    refreshRepliesCount()
                    refreshTweetCount()
                }

                function refreshRepliesCount() {
                    repostButtonList = document.querySelectorAll('.tweet-repost-button')
                    if (repostButtonList !== null) {
                        repostButtonList.forEach(async item => {

                            if (item !== null) {
                                let response = await fetch(`{% url 'get-repost-count' %}?pk=${parseInt(item.value)}`, {
                                    method: 'GET',
                                    headers: {
                                        'X-Requested-With': 'repostTweetCount',
                                        'Content-Type': 'application/json',
                                    }
                                })

                                let data = await response.json()
                                let repostCountText = document.querySelector(`#tweet-repost-${item.value}`)
                                let retweetIcon = document.querySelector(`.retweet-icon-${item.value}`)

                                if (await !data['error'] && await data['action'] == 'reposted') {
                                    if (repostCountText !== null) repostCountText.innerHTML = await data['count']
                                    if (retweetIcon !== null) retweetIcon.classList.add('reposted')
                                } else if (await !data['error']) {
                                    if (repostCountText !== null) repostCountText.innerHTML = await data['count']
                                    if (retweetIcon !== null) retweetIcon.classList.remove('reposted')
                                }
                            }
                        })
                    }
                }

                async function refreshTweetCount() {
                    let countElement = document.querySelector('#tweet-count')
                    if (countElement !== null) {
                        let count = parseInt(countElement.value)
                        let response = await fetch(`{% url 'refresh-tweet-count' %}?count=${count}`, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'refreshTweetCount',
                                'Content-Type': 'application/json'
                            }
                        })

                        data = await response.json()

                        if (await data['has_new']) {
                            document.querySelector('.new-tweet-message').classList.remove('none')
                        } else {
                            document.querySelector('.new-tweet-message').classList.add('none')
                        }

                    }
                }

                function refreshLikes() {
                    document.querySelectorAll('.tweet-like-button').forEach(async item => {
                        if (item !== null) {
                            let response = await fetch(`{% url 'get-like-count' %}?pk=${parseInt(item.value)}`, {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'refreshLikes',
                                    'Content-Type': 'application/json',
                                }
                            })

                            let data = await response.json()
                            let likeCountText = document.querySelector(`#tweet-like-${item.value}`)

                            if (await !data['error'] && await data['action'] == 'liked') {
                                if (likeCountText !== null) likeCountText.innerHTML = await data['count']
                                item.innerHTML = `<i class="fa fa-solid fa-heart"></i>`
                            } else if (await !data['error']) {
                                if (likeCountText !== null) likeCountText.innerHTML = await data['count']
                                item.innerHTML = `<i class="fa fa-regular fa-heart"></i>`
                            }

                        }
                    })
                }
            }, 1000)
        }

        //handle the double scrolling effect
        window.addEventListener('scroll', () => {
            const standartHeight = document.querySelector('.navbar').offsetHeight
            let suggestionsContainer = document.querySelector('.suggestions')

            const maxRemainingHeight = suggestionsContainer.scrollHeight - standartHeight
            const stepLength = maxRemainingHeight / standartHeight

            suggestionsContainer.scrollTop = window.scrollY * stepLength
        })

        //handles the logout form
        function showLogoutForm() {
            document.body.style.overflow = 'hidden'
            let logoutFormFilter = document.querySelector('.logout-form-filter')
            logoutFormFilter.classList.remove('none')
            document.querySelector('#logout-cancel-button').addEventListener('click', closeLogoutForm)

        }

        function closeLogoutForm() {
            logoutFormFilter = document.querySelector('.logout-form-filter')
            logoutFormFilter.classList.add('none')
            document.body.style.overflow = 'scroll'
        }


        function showAndroidNavbar() {
            document.querySelector('.android-navbar').style.left = 0
            document.body.style.overflow = 'hidden'
        }

        function closeAndroidNavbar() {
            document.querySelector('.android-navbar').style.left = '-100%'
            document.body.style.overflow = 'scroll'
        }


    </script>

    {% block script %}
    {% endblock script %}
    <script src="https://kit.fontawesome.com/64fc8803a9.js" crossorigin="anonymous"></script>
</body>

</html>