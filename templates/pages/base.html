{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href=" {% static 'css/Fork-Awesome/css/fork-awesome.min.css' %}?version=1">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?version=1">
    <title>{% block title %}{% endblock title %}Twitter Clone</title>
</head>

<body>
    {% include 'pages/android_navbar.html' %}

    {% block content %}
    {% endblock content %}

    <script>

        LiveUpdates()

        function LiveUpdates() {
            setInterval(() => {
                refreshLikes()
                refreshRepliesCount()
                refreshTweetCount()

                function refreshRepliesCount() {
                    document.querySelectorAll('.tweet-repost-button').forEach(async item => {
                        let response = await fetch(`{% url 'get-repost-count' %}?pk=${parseInt(item.value)}`, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'repostTweetCount',
                                'Content-Type': 'application/json',
                            }
                        })

                        let data = await response.json()
                        let repostCountText = document.querySelector(`#tweet-repost-${item.value}`)
                        repostCountText.innerHTML = await data['count']

                        if (await data['action'] == 'reposted') {
                            console.log(`reposted - ${item.value}`)
                            document.querySelector('.fa-retweet').classList.add('reposted')
                        } else {
                            console.log('not reposted')
                            document.querySelector('.fa-retweet').classList.remove('reposted')
                        }

                    })

                }

                async function refreshTweetCount() {
                    let count = parseInt(document.querySelector('#tweet-count').value)
                    let response = await fetch(`{% url 'refresh-tweet-count' %}?count=${count}`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'refreshTweetCount',
                            'Content-Type': 'application/json'
                        }
                    })

                    data = await response.json()

                    if (await data['has_new']) {
                        document.querySelector('.new-tweet-message').classList.remove('none')
                    } else {
                        document.querySelector('.new-tweet-message').classList.add('none')
                        console.log('none')
                    }
                }

                function refreshLikes() {
                    document.querySelectorAll('.tweet-like-button').forEach(async item => {
                        let response = await fetch(`{% url 'get-like-count' %}?pk=${parseInt(item.value)}`, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'refreshLikes',
                                'Content-Type': 'application/json',
                            }
                        })

                        let data = await response.json()
                        let likeCountText = document.querySelector(`#tweet-like-${item.value}`)
                        likeCountText.innerHTML = await data['count']

                        if (await data['action'] == 'liked') {
                            item.innerHTML = `<i class="fa fa-heart" aria-hidden="true"></i>`
                        } else {
                            item.innerHTML = `<i class="fa fa-heart-o" aria-hidden="true"></i>`
                        }

                    })
                }
            }, 1000)
        }


        //handle the double scrolling effect
        window.addEventListener('scroll', () => {
            const standartHeight = document.querySelector('.navbar').offsetHeight
            let suggestionsContainer = document.querySelector('.suggestions')

            const maxRemainingHeight = suggestionsContainer.scrollHeight - standartHeight
            const stepLength = maxRemainingHeight / standartHeight

            suggestionsContainer.scrollTop = window.scrollY * stepLength
        })

        //handles the logout form
        function showLogoutForm() {
            document.body.style.overflow = 'hidden'
            let logoutFormFilter = document.querySelector('.logout-form-filter')
            logoutFormFilter.classList.remove('none')
            document.querySelector('#logout-cancel-button').addEventListener('click', closeLogoutForm)

        }

        function closeLogoutForm() {
            logoutFormFilter = document.querySelector('.logout-form-filter')
            logoutFormFilter.classList.add('none')
            document.body.style.overflow = 'scroll'
        }


        function showAndroidNavbar() {
            document.querySelector('.android-navbar').style.left = 0
            document.body.style.overflow = 'hidden'
        }

        function closeAndroidNavbar() {
            document.querySelector('.android-navbar').style.left = '-100%'
            document.body.style.overflow = 'scroll'
        }


    </script>

    {% block script %}
    {% endblock script %}
</body>

</html>